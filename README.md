# Проект по анализу кёрлинга с использованием YOLOv8

## Описание проекта
Этот проект посвящён анализу видеоматериалов игры в кёрлинг с целью автоматической детекции и аннотации объектов (камней и дома) на кадрах видео. Проект включает подготовку видеоданных, создание масок, аннотаций, дообучение модели YOLOv8, а также формирование демонстрационного видео и метрик. Основные задачи:
- Обработка видеоматериалов для выделения информативных кадров.
- Создание масок для баннеров, фона, дома и камней (жёлтых и красных).
- Аннотация объектов (камни и дом) для дообучения модели.
- Дообучение модели YOLOv8 для детекции объектов.
- Формирование выходных артефактов: CSV с координатами камней, отчёт с метриками и демонстрационное видео.

## Структура репозитория

```
├── Выходные_Артефакты
│   ├── Формирование_демонстрационного_видео_и_метрик.ipynb
│   ├── stones_coordinates.csv        # Координаты камней (frame_id, stone_id, team, x_cm, y_cm)
│   ├── report.md                    # Отчёт с метриками (Precision, Recall, MAE)
│   └── demo_video.mp4.txt           # Наименование демонстрационного видео 1-го энда
├── Данные
│   ├── 1_end.mp4.txt                # Наименование видео 1-го энда
│   └── Участок_с_полного_матча.mp4.txt  # Наименование участка полного матча
├── Дообучение_YOLO
│   ├── curling_yolov8.pt            # Дообученная модель YOLOv8
│   ├── Дообучение_YOLO.ipynb        # Блокнот с дообучением модели
│   └── Распределение_на_выборки_для_дообучения
│       └── Распределение_кадров_для_дообучения_Yolo.ipynb  # Распределение кадров на выборки
├── Отбор_кадров_по_углам_обзора
│   └── Отбор_нужных_углов_обзора_С_ТЕСТАМИ.ipynb  # Отбор кадров по углам обзора
├── Подготовка_видео_полного_матча.ipynb  # Подготовка видео и разметка кадров
├── Создание_Аннотаций
│   ├── 1_ЭНД_Прод_Версия_Аннотации.ipynb  # Аннотации для 1-го энда
│   ├── Готовы_Банеры+Фон_Дом_Камни_ЕСТЬ_АННОТАЦИИ_ДЛЯ_ОЦЕНКИ.ipynb  # Аннотации для оценки
│   ├── ДЕКАРТОВЫ_КООРДИНАТЫ.ipynb  # Перевод координат в декартову систему
│   └── Полный_Матч_Прод_Версия_Аннотации.ipynb  # Аннотации для полного матча
├── Создание_Масок
│   ├── 1_УГОЛ_Готовы_Банеры+Фон_Дом_Камни_ЕСТЬ_АННОТАЦИИ_ДЛЯ_ОЦЕНКИ.ipynb  # Маски для 1-го угла
│   ├── 2_УГОЛ_Готовы_Банеры+Фон_Дом_Камни_ЕСТЬ_АННОТАЦИИ_ДЛЯ_ОЦЕНКИ.ipynb  # Маски для 2-го угла
│   ├── Готовы_Баннеры(HSV).ipynb  # Маски баннеров (HSV)
│   ├── Готовы_Баннеры_и_Камни(HSV).ipynb  # Маски баннеров и камней (HSV)
│   ├── Готовы_Баннеры+Фон_и_Камни(HSV).ipynb  # Маски баннеров, фона и камней (HSV)
│   └── ДЛЯ_1_И_2_УГОЛ_Готовы_Банеры+Фон_Дом_Камни_ЕСТЬ_АННОТАЦИИ_ДЛЯ_ОЦЕНКИ.ipynb  # Общие маски для 1-го и 2-го углов
```

## Основные этапы работы

### 1. Подготовка видео (`Подготовка_видео_полного_матча.ipynb`)
Блокнот включает два основных блока: **Подготовка видео** и **Разметка кадров**.

#### Блок Подготовки Видео
- Удаление чёрного экрана в конце исходного видео.
- Обрезка видео для исключения нижнего баннера из кадра.
- Вырезка участка видео (3-й энд, с 30-й минуты, длительностью 1 час).
- Сохранение участка в формате `.mp4` с разрешением 1094x540 и кодеком H.264 (Main Profile), подходящим для прямых трансляций.
- Итоговый файл: `[Участок_с_полного_матча.mp4](https://drive.google.com/file/d/1hKV-zDKKmt67I5KiwzFyuLxwLfW1LB1y/view?usp=drive_link)'.

#### Блок Разметки Кадров
- Используется видео `Участок_с_полного_матча.mp4`.
- Отбор кадров по двум наиболее информативным ракурсам:
  - Сохранение двух эталонных кадров.
  - Разделение кадров на сегменты.
  - Отбор подходящих кадров с использованием метрик SSIM и MSE.
- Подготовка отобранных кадров к созданию аннотаций через создание масок:
  - **Маска баннеров**: Исключение по координатам в кадре.
  - **Маска фона**: Использование HSV для создания контуров и морфологические операции.
  - **Маска дома**: HSV, морфологические операции, фильтр по площади контуров.
  - **Маска жёлтых камней**: HSV, морфологические операции, проверка на эллипс, фильтр по площади.
  - **Маска красных камней**: Аналогично жёлтым камням.
- Создание аннотаций для жёлтых и красных камней, а также дома.

### 2. Дообучение модели YOLOv8 (`Дообучение_YOLO.ipynb`)
- Дообучение модели YOLOv8 на подготовленном датасете.
- Итоговая модель сохранена как [curling_yolov8.pt](https://drive.google.com/file/d/1pw3oY5YZMYp5gtUvZ73ImHaSMbfJxOE0/view?usp=drive_link).

### 3. Формирование выходных артефактов
Блокнот `Формирование_демонстрационного_видео_и_метрик.ipynb` создаёт:
- **Демонстрационное видео** ([demo_video.mp4](https://drive.google.com/file/d/1Jhj4xsSC8uIH2_jc5SWPttkyufj5xmTf/view?usp=drive_link)): Видео 1-го энда с визуализацией детекций (рамки, цвет команды, координаты).
- **CSV-файл** ([`stones_coordinates.csv`](https://drive.google.com/file/d/1UAQ186HCG7Z7zR8-8mM9531-y5qLtewS/view?usp=drive_link)): Координаты камней в формате `frame_id, stone_id, team, x_cm, y_cm`.
- **Отчёт** ([`report.md`](https://drive.google.com/file/d/1zJpIvS5dSbhc4LAOrKbMg4XFN6QK5ogm/view?usp=drive_link)): Метрики:
  - Precision: 1.000
  - Recall: 0.932
  - MAE по координатам (см): 1308.209

## Используемые видеоматериалы
Видеоматериалы, упомянутые в папке `Данные` ([1_end.mp4](https://drive.google.com/file/d/1Rbm4t42_yh0jjgpjBJPOmxHmS9Z9zxC2/view?usp=drive_link), [`Участок_с_полного_матча.mp4`](https://drive.google.com/file/d/1hKV-zDKKmt67I5KiwzFyuLxwLfW1LB1y/view?usp=drive_link)), доступны по [ссылке на Google Drive](https://drive.google.com/drive/folders/1a9mGi1WSfmFQ2zBqm0lF9XihH8I6afPN?usp=drive_link).

## Возможные улучшения
1. **Улучшение подсчёта плоской гомографии**:
   - Использование методов SLAM, SIFT или трекинга для повышения точности метрики MAE по координатам.
2. **Добавление трекинга камней**:
   - Реализация отслеживания движения камней для улучшения детекции.

## Заметки
- Файлы `.txt` в папке `Данные` содержат наименования использованных видеоматериалов.
- Промежуточные блокноты (в папках `Создание_Масок`, `Создание_Аннотаций`, `Отбор_кадров_по_углам_обзора`) содержат визуализации для прозрачности разметки данных.

## Требования
- Python 3.8+
- Библиотеки: `ultralytics`, `opencv-python`, `scikit-image`, `numpy`, `pandas`, `ffmpeg-python`
- Google Colab с подключением Google Drive для работы с данными и сохранения результатов.

## Инструкция по запуску
1. Склонируйте репозиторий.
2. Загрузите видеоматериалы с Google Drive.
3. Запустите блокноты в следующем порядке:
   - `Подготовка_видео_полного_матча.ipynb`
   - `Создание_Масок/*.ipynb` (для создания масок)
   - `Создание_Аннотаций/*.ipynb` (для создания аннотаций)
   - `Дообучение_YOLO/Дообучение_YOLO.ipynb` (для дообучения модели)
   - `Формирование_демонстрационного_видео_и_метрик.ipynb` (для создания выходных артефактов)
